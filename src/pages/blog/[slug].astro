---
import BlogPost from '../../layouts/BlogPost.astro';
import Navigation from '../../components/Navigation';
import Footer from '../../components/Footer.astro';
import Blog from '../../components/Blog';
import BlogSidebar from '../../components/BlogSidebar.astro';
import { getCollection, getEntryBySlug } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('blog');
  return posts.map((post) => ({ params: { slug: post.slug } }));
}

const { slug } = Astro.params;

// Get the markdown content
const entry = await getEntryBySlug('blog', slug);

if (!entry) {
  return Astro.redirect('/404');
}

const { Content } = await entry.render();
const formattedDate = new Date(entry.data.date).toLocaleDateString('de-DE', {
  day: '2-digit',
  month: 'long',
  year: 'numeric'
});
const formattedUpdatedDate = entry.data.updatedDate
  ? new Date(entry.data.updatedDate).toLocaleDateString('de-DE', {
      day: '2-digit',
      month: 'long',
      year: 'numeric'
    })
  : null;

// Get all posts except the current one and pick 3 random ones
const allPosts = await getCollection('blog');
const otherPosts = allPosts
  .filter(post => post.slug !== slug)
  .map(p => ({
    slug: p.slug,
    title: p.data.title,
    description: p.data.description,
    category: p.data.category,
    readTime: p.data.readTime,
    author: p.data.author,
    date: p.data.date,
    image: p.data.image || "/placeholder.svg"
  }))
  .sort(() => Math.random() - 0.5)
  .slice(0, 3);
---

<BlogPost
  title={entry.data.title}
  description={entry.data.description}
  author={entry.data.author}
  date={entry.data.date}
  updatedDate={entry.data.updatedDate}
  category={entry.data.category}
  readTime={entry.data.readTime}
  image={entry.data.image}
>
  <div class="min-h-screen bg-background">
    <!-- Navigation -->
    <Navigation client:load />

    <!-- Breadcrumbs -->
    <nav class="pt-32 pb-4" aria-label="Breadcrumb">
      <div class="max-w-4xl mx-auto px-6">
        <ol class="flex items-center gap-2 text-sm text-muted-foreground" itemscope itemtype="https://schema.org/BreadcrumbList">
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a href="/" itemprop="item" class="hover:text-foreground transition-colors">
              <span itemprop="name">Home</span>
            </a>
            <meta itemprop="position" content="1" />
          </li>
          <li aria-hidden="true">/</li>
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <a href="/blog" itemprop="item" class="hover:text-foreground transition-colors">
              <span itemprop="name">Blog</span>
            </a>
            <meta itemprop="position" content="2" />
          </li>
          <li aria-hidden="true">/</li>
          <li itemprop="itemListElement" itemscope itemtype="https://schema.org/ListItem">
            <span itemprop="name" class="text-foreground">{entry.data.title}</span>
            <meta itemprop="position" content="3" />
          </li>
        </ol>
      </div>
    </nav>

    <!-- Blog Post Content -->
    <article class="pb-16">
      <div class="max-w-6xl mx-auto px-6">
        <!-- Header (full width above grid) -->
        <header class="mb-12 max-w-4xl">
          <span class="inline-block px-3 py-1 text-sm bg-secondary text-secondary-foreground rounded-full mb-4">
            {entry.data.category}
          </span>
          <h1 class="text-4xl md:text-5xl font-bold mb-6 leading-tight">
            {entry.data.title}
          </h1>
          <p class="text-xl text-muted-foreground mb-8 max-w-3xl">
            {entry.data.description}
          </p>
          {entry.data.image && (
            <div class="mb-8">
              <img
                src={entry.data.image}
                alt={`${entry.data.title} - ${entry.data.category} Artikel über KI-Marketing in Frankfurt`}
                class="w-full rounded-xl border border-border shadow-sm"
                loading="eager"
                width="1200"
                height="630"
              />
            </div>
          )}

          <!-- Meta Information -->
          <div class="flex flex-wrap items-center gap-6 text-sm text-muted-foreground border-t border-border pt-6">
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
              </svg>
              <span>{entry.data.author}</span>
            </div>
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              <time datetime={entry.data.date}>
                {formattedDate}
                {formattedUpdatedDate && formattedUpdatedDate !== formattedDate && (
                  <span class="text-xs"> (aktualisiert: {formattedUpdatedDate})</span>
                )}
              </time>
            </div>
            <div class="flex items-center gap-2">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
              </svg>
              <span>{entry.data.readTime}</span>
            </div>
          </div>
        </header>

        <!-- Grid: Article + Sidebar -->
        <div class="lg:grid lg:grid-cols-[1fr_280px] lg:gap-10">
          <!-- Main Content -->
          <div>
            <div class="prose prose-lg prose-headings:text-foreground prose-p:text-muted-foreground prose-strong:text-foreground prose-ul:text-muted-foreground prose-li:text-muted-foreground" style="max-width: none !important; width: 100% !important;">
              <Content />
            </div>

            <!-- Back to Blog -->
            <div class="mt-16 pt-8 border-t border-border">
              <a href="/blog" class="inline-flex items-center px-4 py-2 border border-input bg-background hover:bg-accent hover:text-accent-foreground rounded-2xl transition-colors">
                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Zurück zu allen Artikeln
              </a>
            </div>
          </div>

          <!-- Sidebar (sticky, hidden on mobile) -->
          <div class="hidden lg:block">
            <div class="sticky top-32">
              <BlogSidebar />
            </div>
          </div>
        </div>

        <!-- Sidebar mobile (below article) -->
        <div class="mt-12 lg:hidden">
          <BlogSidebar />
        </div>
      </div>
    </article>

    <!-- Related Articles -->
    {otherPosts.length > 0 && (
      <div class="py-16 bg-gradient-to-b from-blue-400/5 via-purple-400/5 to-transparent">
        <div class="max-w-7xl mx-auto px-6">
          <h2 class="text-3xl md:text-4xl font-bold mb-12 text-center">
            Weitere interessante Artikel
          </h2>
          <Blog client:load posts={otherPosts} limit={3} showViewAll={false} />
        </div>
      </div>
    )}

    <!-- Footer -->
    <Footer />
  </div>
</BlogPost>
